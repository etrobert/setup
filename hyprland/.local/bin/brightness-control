#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

if [ $# -eq 0 ]; then
  echo "Usage: brightness-control [up|down]"
  exit 1
fi

DIRECTION=$1

# Get the focused monitor from Hyprland
MONITOR=$(hyprctl activeworkspace -j | jq -r '.monitor')

# Find the backlight device for this monitor by checking device paths
DEVICE_ARG=""
for bl in /sys/class/backlight/*; do
  if readlink -f "$bl" | grep -q "card[0-9]*-${MONITOR}"; then
    DEVICE_ARG="-d $(basename "$bl")"
    break
  fi
done

if [ -z "$DEVICE_ARG" ]; then
  echo "Warning: No backlight device found for monitor $MONITOR, using default" >&2
fi

# shellcheck disable=SC2086 # DEVICE_ARG intentionally unquoted to expand to nothing or "-d name"
if [ "$DIRECTION" = "up" ]; then
  brightnessctl $DEVICE_ARG set --min-value=1 10%+
elif [ "$DIRECTION" = "down" ]; then
  brightnessctl $DEVICE_ARG set --min-value=1 10%-
fi
# shellcheck disable=SC2086 # DEVICE_ARG intentionally unquoted to expand to nothing or "-d name"
PERCENT=$(brightnessctl $DEVICE_ARG -m | cut -d, -f4 | tr -d %)

notify-send -h int:value:"$PERCENT" \
  -h string:x-canonical-private-synchronous:brightness \
  "Brightness" "$PERCENT%"
