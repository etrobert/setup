#!/bin/sh

set -e

dump_packages() {
  echo "Dumping official packages to pkglist.txt..."
  pacman -Qqen >pkglist.txt
  echo "✅ Dumped $(wc -l <pkglist.txt) official packages to pkglist.txt"

  echo "Dumping AUR packages to foreignpkglist.txt..."
  pacman -Qqem >foreignpkglist.txt
  echo "✅ Dumped $(wc -l <foreignpkglist.txt) AUR packages to foreignpkglist.txt"
}

install_official_packages() {
  # Check official packages before using sudo
  if [ ! -f "pkglist.txt" ]; then
    echo "pkglist.txt not found, skipping official packages"
    return
  fi

  if sed 's/[[:space:]]*#.*$//' pkglist.txt | pacman -T - >/dev/null 2>&1; then
    echo "✅ All official packages already installed"
    return
  fi

  echo "Installing official packages..."

  sed 's/[[:space:]]*#.*$//' pkglist.txt | sudo pacman -S --needed -
}

install_aur_packages() {
  # Install AUR packages (excluding yay itself)
  if [ ! -f "foreignpkglist.txt" ]; then
    echo "foreignpkglist.txt not found, skipping AUR packages"
    return
  fi

  echo "Installing AUR packages..."
  sed 's/[[:space:]]*#.*$//' foreignpkglist.txt | grep -v '^yay' | yay -S --needed -
}

install_packages() {
  install_official_packages
  install_aur_packages
}

cleanup_packages() {
  echo "Cleaning up packages not in pkglist.txt and foreignpkglist.txt..."

  # Create combined package list (strip comments)
  (
    sed 's/[[:space:]]*#.*$//' pkglist.txt 2>/dev/null
    sed 's/[[:space:]]*#.*$//' foreignpkglist.txt 2>/dev/null
  ) | sort >/tmp/wanted_packages.txt

  # Find packages to remove (installed but not in our lists)
  pacman -Qqe | sort | comm -23 - /tmp/wanted_packages.txt >/tmp/packages_to_remove.txt

  if [ -s /tmp/packages_to_remove.txt ]; then
    echo "Packages to remove:"
    cat /tmp/packages_to_remove.txt
    echo
    # File can be read by user
    # shellcheck disable=SC2024
    sudo pacman -Rsu - </tmp/packages_to_remove.txt
  else
    echo "✅ No packages to remove"
  fi

  # Clean up temp files
  rm -f /tmp/wanted_packages.txt /tmp/packages_to_remove.txt
}

add_package() {
  echo "Adding package to pkglist.txt"

  echo "$1" >>pkglist.txt

  sort pkglist.txt -o pkglist.txt
}

# Require a command
case "$1" in
dump)
  dump_packages
  ;;
install)
  install_packages
  ;;
cleanup)
  cleanup_packages
  ;;
add)
  add_package "$2"
  ;;
*)
  echo "Usage: pacman-bundle {dump|install|cleanup|add}"
  echo "  dump     - Export current packages to pkglist.txt and foreignpkglist.txt"
  echo "  install  - Install packages from both lists"
  echo "  cleanup  - Remove packages not in either list"
  echo "  add      - Add a package to pkglist.txt"
  exit 1
  ;;
esac
